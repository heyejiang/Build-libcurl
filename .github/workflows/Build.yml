name: Build libcurl with CMake

on:
  workflow_dispatch:
    inputs:
      arch:
        description: Architecture
        required: true
        default: 'x64,x86'
        type: string
      build_type:
        description: Build Type
        required: true
        default: both
        type: choice
        options:
          - static
          - shared
          - both
      create_release:
        description: Create Release (requires tag)
        required: false
        default: false
        type: boolean

  push:
    tags:
      - v*

jobs:
  build:
    runs-on: windows-latest

    strategy:
      matrix:
        arch: ${{ fromJSON(format('[{0}]', github.event.inputs.arch)) }}

    steps:
      - name: Setup Visual Studio
        uses: ilammy/msvc-dev-cmd@v1
        with:
          arch: ${{ matrix.arch == 'x64' && 'x64' || 'x86' }}

      - name: Install vcpkg
        run: |
          git clone https://github.com/Microsoft/vcpkg.git
          .\vcpkg\bootstrap-vcpkg.bat

      - name: Install dependencies for ${{ matrix.arch }}
        run: |
          $triplet = "${{ matrix.arch }}-windows"
          $triplet_static = "${{ matrix.arch }}-windows-static"
          .\vcpkg\vcpkg install curl[openssl,ssh,http2,psl] --triplet $triplet_static
          .\vcpkg\vcpkg install curl[openssl,ssh,http2,psl] --triplet $triplet

      - name: Get version
        id: version
        shell: pwsh
        run: |
          $version = "8.18.0" 
          if ("${{ github.ref }}" -match "refs/tags/v(.*)") { 
            $version = $matches[1] 
          } 
          echo "version=$version" >> $env:GITHUB_OUTPUT

      - name: Package static for ${{ matrix.arch }}
        if: github.event.inputs.build_type == 'static' || github.event.inputs.build_type == 'both'
        shell: pwsh
        run: |
          $ver = "${{ steps.version.outputs.version }}"
          $arch = "${{ matrix.arch }}"
          $dir = "libcurl-${ver}-${arch}-static"
          New-Item -ItemType Directory -Path $dir -Force
          New-Item -ItemType Directory -Path "$dir\lib" -Force
          New-Item -ItemType Directory -Path "$dir\include" -Force

          $src = "vcpkg\packages\curl_${{ matrix.arch }}-windows-static"
          if (Test-Path $src) {
            Copy-Item -Path "$src\lib\*.lib" -Destination "$dir\lib\" -Force
            Copy-Item -Path "$src\include\*" -Destination "$dir\include\" -Recurse -Force
          }

          # Copy static libraries for dependencies
          $dependencies = @("libssl", "libcrypto", "libssh2")
          foreach ($lib in $dependencies) {
              Copy-Item -Path "vcpkg\packages\$lib_${{ matrix.arch }}-windows-static\lib\*.lib" -Destination "$dir\lib\" -Force
          }

          Compress-Archive -Path "$dir\*" -DestinationPath "$dir.zip" -Force

      - name: Package shared for ${{ matrix.arch }}
        if: github.event.inputs.build_type == 'shared' || github.event.inputs.build_type == 'both'
        shell: pwsh
        run: |
          $ver = "${{ steps.version.outputs.version }}"
          $arch = "${{ matrix.arch }}"
          $dir = "libcurl-${ver}-${arch}-shared"
          New-Item -ItemType Directory -Path $dir -Force
          New-Item -ItemType Directory -Path "$dir\lib" -Force
          New-Item -ItemType Directory -Path "$dir\bin" -Force
          New-Item -ItemType Directory -Path "$dir\include" -Force

          $src = "vcpkg\packages\curl_${{ matrix.arch }}-windows"
          if (Test-Path $src) {
            Copy-Item -Path "$src\bin\*.dll" -Destination "$dir\bin\" -Force
            Copy-Item -Path "$src\lib\*.lib" -Destination "$dir\lib\" -Force
            Copy-Item -Path "$src\include\*" -Destination "$dir\include\" -Recurse -Force
          }

          # Copy shared libraries for dependencies
          $dependencies = @("libssl", "libcrypto", "libssh2")
          foreach ($lib in $dependencies) {
              Copy-Item -Path "vcpkg\packages\$lib_${{ matrix.arch }}-windows\lib\*.lib" -Destination "$dir\lib\" -Force
          }

          Compress-Archive -Path "$dir\*" -DestinationPath "$dir.zip" -Force

      - name: Upload static for ${{ matrix.arch }}
        if: github.event.inputs.build_type == 'static' || github.event.inputs.build_type == 'both'
        uses: actions/upload-artifact@v4
        with:
          name: libcurl-${{ matrix.arch }}-static
          path: libcurl-*-static.zip

      - name: Upload shared for ${{ matrix.arch }}
        if: github.event.inputs.build_type == 'shared' || github.event.inputs.build_type == 'both'
        uses: actions/upload-artifact@v4
        with:
          name: libcurl-${{ matrix.arch }}-shared
          path: libcurl-*-shared.zip

  release:
    needs: build
    runs-on: ubuntu-latest
    if: |
      startsWith(github.ref, 'refs/tags/v') ||
      (github.event_name == 'workflow_dispatch' && github.event.inputs.create_release == 'true')
    permissions:
      contents: write
    steps:
      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts
          merge-multiple: true

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          name: libcurl ${{ github.ref_name }} for MSVC
          tag_name: ${{ github.ref_name }} 
          body: |
            ## Architectures
            - x64 (64-bit) 
            - x86 (32-bit) 
            
            ## Library Files
            - libcurl.lib (static library) 
            - libcurl_imp.lib (import library for DLL) 
            - libssl.lib
            - libcrypto.lib
            - libssh2.lib
            
            ## System Libraries Required
            - crypt32.lib
            
            ## Static Build
            - Use: libcurl.lib + all dependency libs
            - Define: CURL_STATICLIB
            
            ## Dynamic Build
            - Use: libcurl_imp.lib
            - DLLs in bin/ folder
          files: artifacts/*.zip
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
