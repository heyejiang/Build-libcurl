name: Build libcurl with CMake

on:
  workflow_dispatch:
    inputs:
      arch:
        description: Architecture
        required: true
        default: x64
        type: choice
        options:
          - x64
          - x86
          - x64_x86
      build_type:
        description: Build Type
        required: true
        default: both
        type: choice
        options:
          - static
          - shared
          - both
      create_release:
        description: Create Release (requires tag)
        required: false
        default: false
        type: boolean

  push:
    tags:
      - v*

jobs:
  build:
    runs-on: windows-latest
    
    # 修复矩阵策略：根据输入动态生成矩阵
    strategy:
      matrix:
        arch: ${{ fromJSON(format('[{0}]', github.event.inputs.arch || 'x64')) }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Visual Studio
        uses: ilammy/msvc-dev-cmd@v1
        with:
          arch: ${{ matrix.arch == 'x64' && 'x64' || (matrix.arch == 'x86' && 'x86' || 'amd64_x86') }}

      - name: Install vcpkg
        run: |
          git clone https://github.com/Microsoft/vcpkg.git
          .\vcpkg\bootstrap-vcpkg.bat

      - name: Install dependencies for ${{ matrix.arch }}
        run: |
          $arch = "${{ matrix.arch }}"
          if ($arch -eq "x64_x86") {
            $triplet_static = "x86-windows-static"
            $triplet = "x86-windows"
          } else {
            $triplet_static = "$arch-windows-static"
            $triplet = "$arch-windows"
          }
          .\vcpkg\vcpkg install curl[openssl,ssh,http2,psl] --triplet $triplet_static
          .\vcpkg\vcpkg install curl[openssl,ssh,http2,psl] --triplet $triplet

      - name: Get version
        id: version
        shell: pwsh
        run: |
          $version = "8.18.0"
          if ("${{ github.ref }}" -match "refs/tags/v(.*)") {
            $version = $matches[1]
          }
          echo "version=$version" >> $env:GITHUB_OUTPUT

      - name: Package static for ${{ matrix.arch }}
        if: github.event.inputs.build_type == 'static' || github.event.inputs.build_type == 'both'
        shell: pwsh
        run: |
          $ver = "${{ steps.version.outputs.version }}"
          $arch = "${{ matrix.arch }}"
          $arch_dir = $arch
          if ($arch -eq "x64_x86") { $arch_dir = "x86" }
          
          $dir = "libcurl-${ver}-${arch_dir}-static"
          New-Item -ItemType Directory -Path $dir -Force
          New-Item -ItemType Directory -Path "$dir\lib" -Force
          New-Item -ItemType Directory -Path "$dir\include" -Force

          $triplet = "$arch_dir-windows-static"
          $src = "vcpkg\packages\curl_$triplet"
          if (Test-Path $src) {
            Copy-Item -Path "$src\lib\*.lib" -Destination "$dir\lib\" -Force
            Copy-Item -Path "$src\include\*" -Destination "$dir\include\" -Recurse -Force
          }

          # Copy static libraries for dependencies
          $dependencies = @("libssl", "libcrypto", "libssh2")
          foreach ($lib in $dependencies) {
              $dep_src = "vcpkg\packages\${lib}_$triplet"
              if (Test-Path $dep_src) {
                  Copy-Item -Path "$dep_src\lib\*.lib" -Destination "$dir\lib\" -Force
              }
          }

          Compress-Archive -Path "$dir\*" -DestinationPath "$dir.zip" -Force

      - name: Package shared for ${{ matrix.arch }}
        if: github.event.inputs.build_type == 'shared' || github.event.inputs.build_type == 'both'
        shell: pwsh
        run: |
          $ver = "${{ steps.version.outputs.version }}"
          $arch = "${{ matrix.arch }}"
          $arch_dir = $arch
          if ($arch -eq "x64_x86") { $arch_dir = "x86" }
          
          $dir = "libcurl-${ver}-${arch_dir}-shared"
          New-Item -ItemType Directory -Path $dir -Force
          New-Item -ItemType Directory -Path "$dir\lib" -Force
          New-Item -ItemType Directory -Path "$dir\bin" -Force
          New-Item -ItemType Directory -Path "$dir\include" -Force

          $triplet = "$arch_dir-windows"
          $src = "vcpkg\packages\curl_$triplet"
          if (Test-Path $src) {
            Copy-Item -Path "$src\bin\*.dll" -Destination "$dir\bin\" -Force
            Copy-Item -Path "$src\lib\*.lib" -Destination "$dir\lib\" -Force
            Copy-Item -Path "$src\include\*" -Destination "$dir\include\" -Recurse -Force
          }

          # Copy import libraries for dependencies
          $dependencies = @("libssl", "libcrypto", "libssh2")
          foreach ($lib in $dependencies) {
              $dep_src = "vcpkg\packages\${lib}_$triplet"
              if (Test-Path $dep_src) {
                  Copy-Item -Path "$dep_src\lib\*.lib" -Destination "$dir\lib\" -Force
                  if (Test-Path "$dep_src\bin") {
                      Copy-Item -Path "$dep_src\bin\*.dll" -Destination "$dir\bin\" -Force
                  }
              }
          }

          Compress-Archive -Path "$dir\*" -DestinationPath "$dir.zip" -Force

      - name: Upload static for ${{ matrix.arch }}
        if: github.event.inputs.build_type == 'static' || github.event.inputs.build_type == 'both'
        uses: actions/upload-artifact@v4
        with:
          name: libcurl-${{ matrix.arch }}-static
          path: libcurl-*-static.zip

      - name: Upload shared for ${{ matrix.arch }}
        if: github.event.inputs.build_type == 'shared' || github.event.inputs.build_type == 'both'
        uses: actions/upload-artifact@v4
        with:
          name: libcurl-${{ matrix.arch }}-shared
          path: libcurl-*-shared.zip

  release:
    needs: build
    runs-on: ubuntu-latest
    if: |
      startsWith(github.ref, 'refs/tags/v') ||
      (github.event_name == 'workflow_dispatch' && github.event.inputs.create_release == 'true')
    permissions:
      contents: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts
          merge-multiple: true

      - name: Get version
        id: version
        run: |
          if [[ "${{ github.ref }}" =~ ^refs/tags/v(.*)$ ]]; then
            VERSION="${BASH_REMATCH[1]}"
          else
            VERSION="8.18.0"
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT

      - name: Update README.md
        run: |
          # 创建或更新README.md
          cat > README.md << 'EOF'
          # libcurl for MSVC

          Pre-built libcurl binaries for Windows with MSVC.

          ## Version ${{ steps.version.outputs.version }}

          ## Features
          - OpenSSL support
          - SSH support (libssh2)
          - HTTP/2 support (nghttp2)
          - Public Suffix List (PSL)

          ## Architectures
          - x64 (64-bit)
          - x86 (32-bit)

          ## Library Files
          - libcurl.lib (static library)
          - libcurl_imp.lib (import library for DLL)
          - libssl.lib
          - libcrypto.lib
          - libssh2.lib

          ## System Libraries Required
          - crypt32.lib
          - bcrypt.lib (for OpenSSL)
          - user32.lib (for OpenSSL)

          ## Static Build
          - Use: libcurl.lib + all dependency libs
          - Define: `CURL_STATICLIB`
          - Example: `target_link_libraries(your_target libcurl libssl libcrypto libssh2 crypt32 bcrypt user32)`

          ## Dynamic Build
          - Use: libcurl_imp.lib
          - DLLs in bin/ folder
          - Example: `target_link_libraries(your_target libcurl_imp)`

          ## Downloads
          EOF

          # 添加下载链接
          echo "" >> README.md
          echo "### Static Libraries" >> README.md
          for file in artifacts/libcurl-*-static.zip; do
            if [ -f "$file" ]; then
              name=$(basename "$file")
              arch=$(echo "$name" | sed -E 's/libcurl-[0-9.]+-([^-]+)-static\.zip/\1/')
              echo "- [$arch]($name)" >> README.md
            fi
          done

          echo "" >> README.md
          echo "### Shared Libraries" >> README.md
          for file in artifacts/libcurl-*-shared.zip; do
            if [ -f "$file" ]; then
              name=$(basename "$file")
              arch=$(echo "$name" | sed -E 's/libcurl-[0-9.]+-([^-]+)-shared\.zip/\1/')
              echo "- [$arch]($name)" >> README.md
            fi
          done

          # 将README.md添加到 artifacts 目录
          cp README.md artifacts/

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          name: libcurl ${{ github.ref_name }} for MSVC
          tag_name: ${{ github.ref_name }}
          body: |
            ## libcurl ${{ steps.version.outputs.version }} for MSVC

            ## Features
            - OpenSSL support
            - SSH support (libssh2)
            - HTTP/2 support (nghttp2)
            - Public Suffix List (PSL)

            ## Architectures
            - x64 (64-bit)
            - x86 (32-bit)

            ## Library Files
            - libcurl.lib (static library)
            - libcurl_imp.lib (import library for DLL)
            - libssl.lib
            - libcrypto.lib
            - libssh2.lib

            ## System Libraries Required
            - crypt32.lib
            - bcrypt.lib
            - user32.lib

            ## Static Build
            - Use: libcurl.lib + all dependency libs
            - Define: `CURL_STATICLIB`

            ## Dynamic Build
            - Use: libcurl_imp.lib
            - DLLs in bin/ folder

            ## Notes
            - Built with Visual Studio 2022
            - Includes all necessary dependencies
          files: |
            artifacts/*.zip
            artifacts/README.md
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
