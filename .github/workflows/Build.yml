name: Build libcurl with CMake

on:
  workflow_dispatch:
    inputs:
      arch:
        description: Architecture
        required: true
        default: x64
        type: choice
        options:
          - x64
          - x86
      build_type:
        description: Build Type
        required: true
        default: both
        type: choice
        options:
          - static
          - shared
          - both
  push:
    tags:
      - v*

jobs:
  build:
    runs-on: windows-latest
    strategy:
      matrix:
        arch: [${{ github.event.inputs.arch }}]
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Visual Studio
        uses: ilammy/msvc-dev-cmd@v1
        with:
          arch: ${{ matrix.arch }}

      - name: Download OpenSSL
        shell: pwsh
        run: |
          if ("${{ matrix.arch }}" -eq "x64") {
            $url = "https://slproweb.com/download/Win64OpenSSL-3_5_5.exe"
          } else {
            $url = "https://slproweb.com/download/Win32OpenSSL-3_5_5.exe"
          }
          Invoke-WebRequest -Uri $url -OutFile openssl.exe
          .\openssl.exe /silent /verysilent /dir=C:\openssl

      - name: Download zlib
        shell: cmd
        run: |
          cd C:\
          git clone --depth 1 --branch v1.3.2 https://github.com/madler/zlib.git
          cd zlib
          nmake /f win32\Makefile.msc
          mkdir C:\zlib\lib 2>nul
          mkdir C:\zlib\include 2>nul
          copy zlib.lib C:\zlib\lib\
          copy zlib.h C:\zlib\include\
          copy zconf.h C:\zlib\include\

      - name: Clone curl
        shell: cmd
        run: |
          cd C:\
          git clone --depth 1 --branch curl-8_18_0 https://github.com/curl/curl.git

      - name: Get version
        id: version
        shell: pwsh
        run: |
          $version = "8.18.0"
          if ("${{ github.ref }}" -match "refs/tags/v(.*)") {
            $version = $matches[1]
          }
          echo "version=$version" >> $env:GITHUB_OUTPUT
          echo "date=$(Get-Date -Format yyyy-MM-dd)" >> $env:GITHUB_OUTPUT

      - name: Configure static build
        if: github.event.inputs.build_type == 'static' || github.event.inputs.build_type == 'both'
        shell: cmd
        run: |
          cd C:\curl
          mkdir build-static
          cd build-static
          cmake .. -G "Visual Studio 17 2022" -A ${{ matrix.arch == 'x64' && 'x64' || 'Win32' }} ^
            -DCMAKE_INSTALL_PREFIX=C:\curl-static ^
            -DBUILD_SHARED_LIBS=OFF ^
            -DCMAKE_USE_OPENSSL=ON ^
            -DOPENSSL_ROOT_DIR=C:\openssl ^
            -DOPENSSL_INCLUDE_DIR=C:\openssl\include ^
            -DOPENSSL_CRYPTO_LIBRARY=C:\openssl\lib\libcrypto.lib ^
            -DOPENSSL_SSL_LIBRARY=C:\openssl\lib\libssl.lib ^
            -DZLIB_ROOT=C:\zlib ^
            -DZLIB_LIBRARY=C:\zlib\lib\zlib.lib ^
            -DZLIB_INCLUDE_DIR=C:\zlib\include ^
            -DHTTP_ONLY=OFF ^
            -DENABLE_IPV6=ON ^
            -DBUILD_CURL_EXE=OFF ^
            -DBUILD_TESTING=OFF ^
            -DCURL_DISABLE_LDAP=ON ^
            -DCURL_DISABLE_LDAPS=ON ^
            -DUSE_NGHTTP2=OFF ^
            -DUSE_LIBIDN2=OFF ^
            -DUSE_LIBPSL=OFF ^
            -DUSE_BROTLI=OFF ^
            -DUSE_ZSTD=OFF

      - name: Build static
        if: github.event.inputs.build_type == 'static' || github.event.inputs.build_type == 'both'
        shell: cmd
        run: |
          cd C:\curl\build-static
          cmake --build . --config Release
          cmake --install . --config Release

      - name: Configure shared build
        if: github.event.inputs.build_type == 'shared' || github.event.inputs.build_type == 'both'
        shell: cmd
        run: |
          cd C:\curl
          mkdir build-shared
          cd build-shared
          cmake .. -G "Visual Studio 18 2026" -A ${{ matrix.arch == 'x64' && 'x64' || 'Win32' }} ^
            -DCMAKE_INSTALL_PREFIX=C:\curl-shared ^
            -DBUILD_SHARED_LIBS=ON ^
            -DCMAKE_USE_OPENSSL=ON ^
            -DOPENSSL_ROOT_DIR=C:\openssl ^
            -DOPENSSL_INCLUDE_DIR=C:\openssl\include ^
            -DOPENSSL_CRYPTO_LIBRARY=C:\openssl\lib\libcrypto.lib ^
            -DOPENSSL_SSL_LIBRARY=C:\openssl\lib\libssl.lib ^
            -DZLIB_ROOT=C:\zlib ^
            -DZLIB_LIBRARY=C:\zlib\lib\zlib.lib ^
            -DZLIB_INCLUDE_DIR=C:\zlib\include ^
            -DHTTP_ONLY=OFF ^
            -DENABLE_IPV6=ON ^
            -DBUILD_CURL_EXE=OFF ^
            -DBUILD_TESTING=OFF ^
            -DCURL_DISABLE_LDAP=ON ^
            -DCURL_DISABLE_LDAPS=ON ^
            -DUSE_NGHTTP2=OFF ^
            -DUSE_LIBIDN2=OFF ^
            -DUSE_LIBPSL=OFF ^
            -DUSE_BROTLI=OFF ^
            -DUSE_ZSTD=OFF

      - name: Build shared
        if: github.event.inputs.build_type == 'shared' || github.event.inputs.build_type == 'both'
        shell: cmd
        run: |
          cd C:\curl\build-shared
          cmake --build . --config Release
          cmake --install . --config Release

      - name: Package static
        if: github.event.inputs.build_type == 'static' || github.event.inputs.build_type == 'both'
        shell: pwsh
        run: |
          $ver = "${{ steps.version.outputs.version }}"
          $arch = "${{ matrix.arch }}"
          $dir = "libcurl-${ver}-${arch}-static"
          
          New-Item -ItemType Directory -Path $dir -Force
          New-Item -ItemType Directory -Path "$dir\lib" -Force
          New-Item -ItemType Directory -Path "$dir\include" -Force
          
          if (Test-Path "C:\curl-static") {
            Copy-Item -Path "C:\curl-static\lib\*.lib" -Destination "$dir\lib\" -Force
            Copy-Item -Path "C:\curl-static\include\*" -Destination "$dir\include\" -Recurse -Force
          }
          
          # Copy OpenSSL libs
          Copy-Item -Path "C:\openssl\lib\*.lib" -Destination "$dir\lib\" -Force
          
          $readme = @"
          libcurl $ver for MSVC ($arch)
          Build Type: Static Library
          Build Date: ${{ steps.version.outputs.date }}

          Library Files (lib\):
            libcurl.lib           - main curl library
            libssl.lib            - OpenSSL SSL library
            libcrypto.lib         - OpenSSL crypto library
            zlib.lib              - compression library

          Header Files (include\):
            curl/curl.h
            openssl/
            zlib.h

          Visual Studio Configuration:
          1. Add include\ to: C/C++ > General > Additional Include Directories
          2. Add lib\ to: Linker > General > Additional Library Directories
          3. Add to: C/C++ > Preprocessor > Preprocessor Definitions: CURL_STATICLIB
          4. Add to: Linker > Input > Additional Dependencies:
             libcurl.lib
             libssl.lib
             libcrypto.lib
             zlib.lib
             ws2_32.lib
             crypt32.lib
             user32.lib
             advapi32.lib

          Code Example:
          #define CURL_STATICLIB
          #include <curl/curl.h>

          int main() {
              CURL* curl = curl_easy_init();
              if (curl) {
                  curl_easy_setopt(curl, CURLOPT_URL, "https://example.com");
                  curl_easy_perform(curl);
                  curl_easy_cleanup(curl);
              }
              return 0;
          }
          "@
          $readme | Out-File -FilePath "$dir\README.txt" -Encoding ASCII
          Compress-Archive -Path "$dir\*" -DestinationPath "$dir.zip" -Force

      - name: Package shared
        if: github.event.inputs.build_type == 'shared' || github.event.inputs.build_type == 'both'
        shell: pwsh
        run: |
          $ver = "${{ steps.version.outputs.version }}"
          $arch = "${{ matrix.arch }}"
          $dir = "libcurl-${ver}-${arch}-shared"
          
          New-Item -ItemType Directory -Path $dir -Force
          New-Item -ItemType Directory -Path "$dir\lib" -Force
          New-Item -ItemType Directory -Path "$dir\bin" -Force
          New-Item -ItemType Directory -Path "$dir\include" -Force
          
          if (Test-Path "C:\curl-shared") {
            Copy-Item -Path "C:\curl-shared\bin\*.dll" -Destination "$dir\bin\" -Force
            Copy-Item -Path "C:\curl-shared\lib\*.lib" -Destination "$dir\lib\" -Force
            Copy-Item -Path "C:\curl-shared\include\*" -Destination "$dir\include\" -Recurse -Force
          }
          
          # Copy OpenSSL DLLs and libs
          Copy-Item -Path "C:\openssl\bin\*.dll" -Destination "$dir\bin\" -Force
          Copy-Item -Path "C:\openssl\lib\*.lib" -Destination "$dir\lib\" -Force
          
          $readme = @"
          libcurl $ver for MSVC ($arch)
          Build Type: Dynamic Link Library (DLL)
          Build Date: ${{ steps.version.outputs.date }}

          Files:
            bin\*.dll  - DLL files (required at runtime)
              libcurl.dll
              libssl.dll
              libcrypto.dll
              zlib.dll

            lib\*.lib  - Import libraries (required at link time)
              libcurl.lib
              libssl.lib
              libcrypto.lib
              zlib.lib

            include\   - Header files
              curl/curl.h
              openssl/
              zlib.h

          Visual Studio Configuration:
          1. Add include\ to: C/C++ > General > Additional Include Directories
          2. Add lib\ to: Linker > General > Additional Library Directories
          3. Add to: Linker > Input > Additional Dependencies: libcurl.lib
          4. Copy all DLLs from bin\ to your executable directory

          Code Example:
          #include <curl/curl.h>

          int main() {
              CURL* curl = curl_easy_init();
              if (curl) {
                  curl_easy_setopt(curl, CURLOPT_URL, "https://example.com");
                  curl_easy_perform(curl);
                  curl_easy_cleanup(curl);
              }
              return 0;
          }
          "@
          $readme | Out-File -FilePath "$dir\README.txt" -Encoding ASCII
          Compress-Archive -Path "$dir\*" -DestinationPath "$dir.zip" -Force

      - name: Upload static
        if: github.event.inputs.build_type == 'static' || github.event.inputs.build_type == 'both'
        uses: actions/upload-artifact@v4
        with:
          name: libcurl-${{ matrix.arch }}-static
          path: libcurl-*-static.zip

      - name: Upload shared
        if: github.event.inputs.build_type == 'shared' || github.event.inputs.build_type == 'both'
        uses: actions/upload-artifact@v4
        with:
          name: libcurl-${{ matrix.arch }}-shared
          path: libcurl-*-shared.zip

  release:
    needs: build
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/v')
    permissions:
      contents: write
    steps:
      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts
          merge-multiple: true
          
      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          name: libcurl ${{ github.ref_name }} for MSVC
          tag_name: ${{ github.ref_name }}
          body: |
            libcurl ${{ github.ref_name }} for MSVC
            
            Built with CMake, includes:
            - OpenSSL 3.5.5
            - zlib 1.3.2
            
            Architectures:
            - x64 (64-bit)
            - x86 (32-bit)
            
            Build Types:
            - static: Static libraries (.lib)
            - shared: Dynamic libraries (DLL + .lib)
            
            Each package contains:
            - include/ - Header files
            - lib/ - Library files (.lib)
            - bin/ - DLL files (shared only)
            - README.txt - Usage instructions
          files: artifacts/*.zip
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
