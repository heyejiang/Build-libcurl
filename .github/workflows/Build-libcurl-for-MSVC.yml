name: Build libcurl MSVC

on:
  workflow_dispatch:
    inputs:
      arch:
        description: Architecture
        required: true
        default: x64
        type: choice
        options:
          - x64
          - x86
      build_type:
        description: Build Type
        required: true
        default: both
        type: choice
        options:
          - static
          - shared
          - both
  push:
    tags:
      - v*

jobs:
  build:
    runs-on: windows-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Visual Studio
        uses: ilammy/msvc-dev-cmd@v1
        with:
          arch: ${{ github.event.inputs.arch }}

      - name: Install vcpkg
        run: |
          git clone https://github.com/Microsoft/vcpkg.git
          .\vcpkg\bootstrap-vcpkg.bat

      - name: Build static
        if: github.event.inputs.build_type == 'static' || github.event.inputs.build_type == 'both'
        run: .\vcpkg\vcpkg install curl[openssl,ssh,http2,psl] --triplet ${{ github.event.inputs.arch }}-windows-static

      - name: Build shared
        if: github.event.inputs.build_type == 'shared' || github.event.inputs.build_type == 'both'
        run: .\vcpkg\vcpkg install curl[openssl,ssh,http2,psl] --triplet ${{ github.event.inputs.arch }}-windows

      - name: Get version
        id: version
        shell: pwsh
        run: |
          $version = "8.18.0"
          if ("${{ github.ref }}" -match "refs/tags/v(.*)") {
            $version = $matches[1]
          }
          echo "version=$version" >> $env:GITHUB_OUTPUT
          echo "date=$(Get-Date -Format yyyy-MM-dd)" >> $env:GITHUB_OUTPUT

      - name: Package static
        if: github.event.inputs.build_type == 'static' || github.event.inputs.build_type == 'both'
        shell: pwsh
        run: |
          $ver = "${{ steps.version.outputs.version }}"
          $arch = "${{ github.event.inputs.arch }}"
          $date = "${{ steps.version.outputs.date }}"
          $dir = "libcurl-${ver}-${arch}-static"
          
          New-Item -ItemType Directory -Path $dir -Force
          New-Item -ItemType Directory -Path "$dir\lib" -Force
          New-Item -ItemType Directory -Path "$dir\include" -Force
          
          $src = "vcpkg\packages\curl_${{ github.event.inputs.arch }}-windows-static"
          if (Test-Path $src) {
            Copy-Item -Path "$src\lib\*.lib" -Destination "$dir\lib\" -Force
            Copy-Item -Path "$src\include\*" -Destination "$dir\include\" -Recurse -Force
          }
          
          $readme = @"
libcurl $ver for MSVC ($arch)
Build Type: Static Library
Build Date: $date

Library Files (lib\):
  libcurl.lib          - main curl library
  libssl.lib           - OpenSSL SSL library
  libcrypto.lib        - OpenSSL crypto library
  libssh2.lib          - SSH2 library
  zlib.lib             - compression library
  nghttp2.lib          - HTTP/2 library
  psl.lib              - Public Suffix List library

Header Files (include\):
  curl/curl.h
  openssl/...
  libssh2.h
  zlib.h
  nghttp2/...

Visual Studio Configuration:
1. Add include\ to: C/C++ > General > Additional Include Directories
2. Add lib\ to: Linker > General > Additional Library Directories
3. Add to: C/C++ > Preprocessor > Preprocessor Definitions: CURL_STATICLIB
4. Add to: Linker > Input > Additional Dependencies:
   libcurl.lib
   libssl.lib
   libcrypto.lib
   libssh2.lib
   zlib.lib
   nghttp2.lib
   psl.lib
   ws2_32.lib
   crypt32.lib
   wldap32.lib
   bcrypt.lib
   user32.lib

Code Example:
  #define CURL_STATICLIB
  #include <curl/curl.h>
  
  int main() {
      CURL* curl = curl_easy_init();
      if (curl) {
          curl_easy_setopt(curl, CURLOPT_URL, "https://example.com");
          curl_easy_perform(curl);
          curl_easy_cleanup(curl);
      }
      return 0;
  }
"@
          $readme | Out-File -FilePath "$dir\README.txt" -Encoding ASCII
          Compress-Archive -Path "$dir\*" -DestinationPath "$dir.zip" -Force

      - name: Package shared
        if: github.event.inputs.build_type == 'shared' || github.event.inputs.build_type == 'both'
        shell: pwsh
        run: |
          $ver = "${{ steps.version.outputs.version }}"
          $arch = "${{ github.event.inputs.arch }}"
          $date = "${{ steps.version.outputs.date }}"
          $dir = "libcurl-${ver}-${arch}-shared"
          
          New-Item -ItemType Directory -Path $dir -Force
          New-Item -ItemType Directory -Path "$dir\lib" -Force
          New-Item -ItemType Directory -Path "$dir\bin" -Force
          New-Item -ItemType Directory -Path "$dir\include" -Force
          
          $src = "vcpkg\packages\curl_${{ github.event.inputs.arch }}-windows"
          if (Test-Path $src) {
            Copy-Item -Path "$src\bin\*.dll" -Destination "$dir\bin\" -Force
            Copy-Item -Path "$src\lib\*.lib" -Destination "$dir\lib\" -Force
            Copy-Item -Path "$src\include\*" -Destination "$dir\include\" -Recurse -Force
          }
          
          $readme = @"
libcurl $ver for MSVC ($arch)
Build Type: Dynamic Link Library (DLL)
Build Date: $date

Files:
  bin\*.dll  - DLL files (required at runtime)
    libcurl.dll
    libssl.dll
    libcrypto.dll
    libssh2.dll
    zlib.dll
    nghttp2.dll
    psl.dll

  lib\*.lib  - Import libraries (required at link time)
    libcurl.lib
    libssl.lib
    libcrypto.lib
    libssh2.lib
    zlib.lib
    nghttp2.lib
    psl.lib

  include\   - Header files
    curl/curl.h
    openssl/...
    libssh2.h
    zlib.h
    nghttp2/...

Visual Studio Configuration:
1. Add include\ to: C/C++ > General > Additional Include Directories
2. Add lib\ to: Linker > General > Additional Library Directories
3. Add to: Linker > Input > Additional Dependencies: libcurl.lib
4. Copy all DLLs from bin\ to your executable directory or add bin\ to PATH

Code Example:
  #include <curl/curl.h>
  
  int main() {
      CURL* curl = curl_easy_init();
      if (curl) {
          curl_easy_setopt(curl, CURLOPT_URL, "https://example.com");
          curl_easy_perform(curl);
          curl_easy_cleanup(curl);
      }
      return 0;
  }
"@
          $readme | Out-File -FilePath "$dir\README.txt" -Encoding ASCII
          Compress-Archive -Path "$dir\*" -DestinationPath "$dir.zip" -Force

      - name: Upload static
        if: github.event.inputs.build_type == 'static' || github.event.inputs.build_type == 'both'
        uses: actions/upload-artifact@v4
        with:
          name: libcurl-${{ github.event.inputs.arch }}-static
          path: libcurl-*-static.zip

      - name: Upload shared
        if: github.event.inputs.build_type == 'shared' || github.event.inputs.build_type == 'both'
        uses: actions/upload-artifact@v4
        with:
          name: libcurl-${{ github.event.inputs.arch }}-shared
          path: libcurl-*-shared.zip

  release:
    needs: build
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/v')
    permissions:
      contents: write
    steps:
      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts
          merge-multiple: true
          
      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          name: libcurl ${{ github.ref_name }} for MSVC
          tag_name: ${{ github.ref_name }}
          body: |
            libcurl ${{ github.ref_name }} for MSVC

            Built with vcpkg, includes:
            - OpenSSL 3.x
            - libssh2 1.11.0
            - zlib 1.3.1
            - nghttp2 (HTTP/2)
            - libpsl

            Architectures:
            - x64 (64-bit)
            - x86 (32-bit)

            Build Types:
            - static: Static library (.lib)
            - shared: Dynamic library (DLL + .lib)

            Each package contains:
            - include/ - Header files
            - lib/ - Library files (.lib)
            - bin/ - DLL files (shared only)
            - README.txt - Detailed usage instructions

            To use:
            1. Download the appropriate zip file
            2. Extract to your project
            3. Follow README.txt for Visual Studio configuration
          files: artifacts/*.zip
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
