name: curl

on:
  workflow_dispatch:
    inputs:
      arch:
        default: 'x64'
  push:
    tags: ['v*']

jobs:
  build:
    runs-on: windows-latest
    defaults:
      run:
        shell: cmd
        working-directory: D:\a\Build-libcurl\Build-libcurl
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup VS env
        uses: ilammy/msvc-dev-cmd@v1
        with:
          arch: ${{ github.event.inputs.arch }}
      
      - name: Create directories
        run: |
          cd D:\a\Build-libcurl\Build-libcurl
          if exist build rmdir /s /q build
          mkdir build
          cd build
          mkdir install
          echo Current directory: %CD%

      - name: Install vcpkg dependencies
        run: |
          cd D:\a\Build-libcurl\Build-libcurl
          git clone https://github.com/Microsoft/vcpkg.git
          cd vcpkg
          bootstrap-vcpkg.bat
          .\vcpkg.exe install libpsl --triplet ${{ github.event.inputs.arch }}-windows
          .\vcpkg.exe install brotli --triplet ${{ github.event.inputs.arch }}-windows
          .\vcpkg.exe install zstd --triplet ${{ github.event.inputs.arch }}-windows
          .\vcpkg.exe install nghttp2 --triplet ${{ github.event.inputs.arch }}-windows
          .\vcpkg.exe install libidn2 --triplet ${{ github.event.inputs.arch }}-windows

      - name: Build zlib
        run: |
          cd D:\a\Build-libcurl\Build-libcurl\build
          git clone --depth 1 --branch v1.3.1 https://github.com/madler/zlib.git
          cd zlib
          nmake /f win32\Makefile.msc clean
          nmake /f win32\Makefile.msc
          copy zlib.lib ..\install\
          copy zlib.h ..\install\
          copy zconf.h ..\install\
          dir ..\install

      - name: Install OpenSSL
        run: |
          cd D:\a\Build-libcurl\Build-libcurl\build
          if "${{ github.event.inputs.arch }}"=="x64" (
            echo Downloading OpenSSL 64-bit...
            curl -L -o openssl.exe https://slproweb.com/download/Win64OpenSSL-3_5_5.exe
          ) else (
            echo Downloading OpenSSL 32-bit...
            curl -L -o openssl.exe https://slproweb.com/download/Win32OpenSSL-3_5_5.exe
          )
          echo Installing OpenSSL to install directory...
          openssl.exe /silent /verysilent /dir=%CD%\install
          dir install

      - name: Build libssh2
        run: |
          cd D:\a\Build-libcurl\Build-libcurl\build
          git clone --depth 1 --branch libssh2-1.11.0 https://github.com/libssh2/libssh2.git
          cd libssh2
          mkdir build
          cd build
          echo Configuring libssh2...
          cmake .. -G "Visual Studio 17 2022" -A ${{ github.event.inputs.arch == 'x64' && 'x64' || 'Win32' }} ^
            -DCMAKE_INSTALL_PREFIX=D:\a\Build-libcurl\Build-libcurl\build\install ^
            -DCRYPTO_BACKEND=OpenSSL ^
            -DOPENSSL_ROOT_DIR=D:\a\Build-libcurl\Build-libcurl\build\install ^
            -DOPENSSL_INCLUDE_DIR=D:\a\Build-libcurl\Build-libcurl\build\install\include ^
            -DOPENSSL_LIBRARIES="D:\a\Build-libcurl\Build-libcurl\build\install\lib\libssl.lib;D:\a\Build-libcurl\Build-libcurl\build\install\lib\libcrypto.lib" ^
            -DBUILD_SHARED_LIBS=ON ^
            -DBUILD_EXAMPLES=OFF ^
            -DBUILD_TESTING=OFF
          echo Building libssh2...
          cmake --build . --config Release
          echo Installing libssh2...
          cmake --install .
          dir D:\a\Build-libcurl\Build-libcurl\build\install

      - name: Clone curl
        run: |
          cd D:\a\Build-libcurl\Build-libcurl\build
          git clone --depth 1 https://github.com/curl/curl.git
          dir curl

      - name: Build curl static (with disabled optional features)
        run: |
          cd D:\a\Build-libcurl\Build-libcurl\build\curl
          mkdir build-static
          cd build-static
          echo Configuring curl static...
          cmake .. -G "Visual Studio 17 2022" -A ${{ github.event.inputs.arch == 'x64' && 'x64' || 'Win32' }} ^
            -DCMAKE_INSTALL_PREFIX=D:\a\Build-libcurl\Build-libcurl\build\static ^
            -DBUILD_SHARED_LIBS=OFF ^
            -DCMAKE_USE_OPENSSL=ON ^
            -DCMAKE_USE_LIBSSH2=ON ^
            -DUSE_ZLIB=ON ^
            -DOPENSSL_ROOT_DIR=D:\a\Build-libcurl\Build-libcurl\build\install ^
            -DOPENSSL_INCLUDE_DIR=D:\a\Build-libcurl\Build-libcurl\build\install\include ^
            -DOPENSSL_CRYPTO_LIBRARY=D:\a\Build-libcurl\Build-libcurl\build\install\lib\libcrypto.lib ^
            -DOPENSSL_SSL_LIBRARY=D:\a\Build-libcurl\Build-libcurl\build\install\lib\libssl.lib ^
            -DLIBSSH2_LIBRARY=D:\a\Build-libcurl\Build-libcurl\build\install\lib\libssh2.lib ^
            -DLIBSSH2_INCLUDE_DIR=D:\a\Build-libcurl\Build-libcurl\build\install\include ^
            -DZLIB_LIBRARY=D:\a\Build-libcurl\Build-libcurl\build\install\zlib.lib ^
            -DZLIB_INCLUDE_DIR=D:\a\Build-libcurl\Build-libcurl\build\install ^
            -DCURL_DISABLE_LDAP=ON ^
            -DCURL_DISABLE_LDAPS=ON ^
            -DUSE_NGHTTP2=OFF ^
            -DUSE_LIBIDN2=OFF ^
            -DUSE_LIBPSL=OFF ^
            -DUSE_BROTLI=OFF ^
            -DUSE_ZSTD=OFF ^
            -DENABLE_UNICODE=OFF ^
            -DHTTP_ONLY=OFF ^
            -DENABLE_IPV6=ON ^
            -DBUILD_CURL_EXE=OFF ^
            -DBUILD_TESTING=OFF
          echo Building curl static...
          cmake --build . --config Release
          echo Installing curl static...
          cmake --install .
          dir D:\a\Build-libcurl\Build-libcurl\build\static

      - name: Build curl shared (with disabled optional features)
        run: |
          cd D:\a\Build-libcurl\Build-libcurl\build\curl
          mkdir build-shared
          cd build-shared
          echo Configuring curl shared...
          cmake .. -G "Visual Studio 17 2022" -A ${{ github.event.inputs.arch == 'x64' && 'x64' || 'Win32' }} ^
            -DCMAKE_INSTALL_PREFIX=D:\a\Build-libcurl\Build-libcurl\build\shared ^
            -DBUILD_SHARED_LIBS=ON ^
            -DCMAKE_USE_OPENSSL=ON ^
            -DCMAKE_USE_LIBSSH2=ON ^
            -DUSE_ZLIB=ON ^
            -DOPENSSL_ROOT_DIR=D:\a\Build-libcurl\Build-libcurl\build\install ^
            -DOPENSSL_INCLUDE_DIR=D:\a\Build-libcurl\Build-libcurl\build\install\include ^
            -DOPENSSL_CRYPTO_LIBRARY=D:\a\Build-libcurl\Build-libcurl\build\install\lib\libcrypto.lib ^
            -DOPENSSL_SSL_LIBRARY=D:\a\Build-libcurl\Build-libcurl\build\install\lib\libssl.lib ^
            -DLIBSSH2_LIBRARY=D:\a\Build-libcurl\Build-libcurl\build\install\lib\libssh2.lib ^
            -DLIBSSH2_INCLUDE_DIR=D:\a\Build-libcurl\Build-libcurl\build\install\include ^
            -DZLIB_LIBRARY=D:\a\Build-libcurl\Build-libcurl\build\install\zlib.lib ^
            -DZLIB_INCLUDE_DIR=D:\a\Build-libcurl\Build-libcurl\build\install ^
            -DCURL_DISABLE_LDAP=ON ^
            -DCURL_DISABLE_LDAPS=ON ^
            -DUSE_NGHTTP2=OFF ^
            -DUSE_LIBIDN2=OFF ^
            -DUSE_LIBPSL=OFF ^
            -DUSE_BROTLI=OFF ^
            -DUSE_ZSTD=OFF ^
            -DENABLE_UNICODE=OFF ^
            -DHTTP_ONLY=OFF ^
            -DENABLE_IPV6=ON ^
            -DBUILD_CURL_EXE=OFF ^
            -DBUILD_TESTING=OFF
          echo Building curl shared...
          cmake --build . --config Release
          echo Installing curl shared...
          cmake --install .
          dir D:\a\Build-libcurl\Build-libcurl\build\shared

      - name: Get version
        id: version
        shell: pwsh
        run: |
          cd D:\a\Build-libcurl\Build-libcurl\build\curl
          $tag = git describe --tags --abbrev=0 2>$null
          if ($tag) {
            $version = $tag.TrimStart('curl-')
          } else {
            $version = "latest"
          }
          echo "version=$version" >> $env:GITHUB_OUTPUT

      - name: Package
        shell: pwsh
        run: |
          $ver = "${{ steps.version.outputs.version }}"
          $arch = "${{ github.event.inputs.arch }}"
          
          cd D:\a\Build-libcurl\Build-libcurl\build
          
          # Static package
          if (Test-Path static) {
            Compress-Archive -Path static\* -DestinationPath libcurl-${ver}-${arch}-static.zip -Force
          }
          
          # Shared package
          if (Test-Path shared) {
            Compress-Archive -Path shared\* -DestinationPath libcurl-${ver}-${arch}-shared.zip -Force
          }
          
          Get-ChildItem *.zip

      - name: Upload
        uses: actions/upload-artifact@v4
        with:
          name: libcurl-${{ github.event.inputs.arch }}
          path: D:\a\Build-libcurl\Build-libcurl\build\*.zip
