name: Build curl

on:
  workflow_dispatch:
    inputs:
      arch:
        description: 'Architecture (x64/x86)'
        required: true
        default: 'x64'
        type: choice
        options:
          - x64
          - x86
  push:
    tags:
      - 'v*'

jobs:
  build:
    runs-on: windows-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup VS env
        uses: ilammy/msvc-dev-cmd@v1
        with:
          arch: ${{ github.event.inputs.arch }}
      
      - name: Create build directory
        shell: cmd
        run: |
          cd C:\
          if exist curl-build rmdir /s /q curl-build
          mkdir curl-build
          cd curl-build
          mkdir install
          mkdir deps
          echo Build directory created

      - name: Build zlib 1.3.1
        shell: cmd
        run: |
          cd C:\curl-build
          echo Cloning zlib...
          git clone --depth 1 --branch v1.3.1 https://github.com/madler/zlib.git
          cd zlib
          echo Compiling zlib...
          nmake /f win32\Makefile.msc clean
          nmake /f win32\Makefile.msc
          echo Copying zlib files...
          copy zlib.lib ..\install\
          copy zlib.h ..\install\
          copy zconf.h ..\install\
          echo zlib done

      - name: Download OpenSSL 3.0.13
        shell: cmd
        run: |
          cd C:\curl-build
          echo Downloading OpenSSL...
          if "${{ github.event.inputs.arch }}"=="x64" (
            curl -L -o openssl.exe https://slproweb.com/download/Win64OpenSSL-3_0_13.exe
          ) else (
            curl -L -o openssl.exe https://slproweb.com/download/Win32OpenSSL-3_0_13.exe
          )
          echo Installing OpenSSL...
          openssl.exe /silent /verysilent /dir=%CD%\install
          echo OpenSSL done

      - name: Build libssh2 1.11.0
        shell: cmd
        run: |
          cd C:\curl-build
          echo Cloning libssh2...
          git clone --depth 1 --branch libssh2-1.11.0 https://github.com/libssh2/libssh2.git
          cd libssh2
          mkdir build
          cd build
          echo Configuring libssh2...
          cmake .. -G "Visual Studio 17 2022" -A ${{ github.event.inputs.arch == 'x64' && 'x64' || 'Win32' }} ^
            -DCMAKE_INSTALL_PREFIX=C:\curl-build\install ^
            -DCRYPTO_BACKEND=OpenSSL ^
            -DOPENSSL_ROOT_DIR=C:\curl-build\install ^
            -DBUILD_SHARED_LIBS=ON ^
            -DBUILD_EXAMPLES=OFF ^
            -DBUILD_TESTING=OFF
          echo Building libssh2...
          cmake --build . --config Release
          echo Installing libssh2...
          cmake --install .
          echo libssh2 done

      - name: Clone curl latest
        shell: cmd
        run: |
          cd C:\curl-build
          echo Cloning curl latest...
          git clone --depth 1 https://github.com/curl/curl.git
          if exist curl (
            echo curl cloned successfully
            dir curl
          ) else (
            echo Failed to clone curl
            exit 1
          )

      - name: Build curl static
        shell: cmd
        run: |
          cd C:\curl-build\curl
          echo Building curl static...
          mkdir build-static
          cd build-static
          cmake .. -G "Visual Studio 17 2022" -A ${{ github.event.inputs.arch == 'x64' && 'x64' || 'Win32' }} ^
            -DCMAKE_INSTALL_PREFIX=C:\curl-build\install\static ^
            -DBUILD_SHARED_LIBS=OFF ^
            -DCMAKE_USE_OPENSSL=ON ^
            -DCMAKE_USE_LIBSSH2=ON ^
            -DUSE_ZLIB=ON ^
            -DOPENSSL_ROOT_DIR=C:\curl-build\install ^
            -DHTTP_ONLY=OFF ^
            -DENABLE_IPV6=ON ^
            -DBUILD_CURL_EXE=OFF
          cmake --build . --config Release
          cmake --install .
          echo Static build done

      - name: Build curl shared
        shell: cmd
        run: |
          cd C:\curl-build\curl
          echo Building curl shared...
          mkdir build-shared
          cd build-shared
          cmake .. -G "Visual Studio 17 2022" -A ${{ github.event.inputs.arch == 'x64' && 'x64' || 'Win32' }} ^
            -DCMAKE_INSTALL_PREFIX=C:\curl-build\install\shared ^
            -DBUILD_SHARED_LIBS=ON ^
            -DCMAKE_USE_OPENSSL=ON ^
            -DCMAKE_USE_LIBSSH2=ON ^
            -DUSE_ZLIB=ON ^
            -DOPENSSL_ROOT_DIR=C:\curl-build\install ^
            -DHTTP_ONLY=OFF ^
            -DENABLE_IPV6=ON ^
            -DBUILD_CURL_EXE=OFF
          cmake --build . --config Release
          cmake --install .
          echo Shared build done

      - name: Get version
      - name: Get version
        id: version
        shell: pwsh
        run: |
          cd C:\curl-build\curl
          $tag = git describe --tags --abbrev=0 2>$null
          if ($tag) {
            $version = $tag.TrimStart('curl-')
          } else {
            $version = "latest"
          }
          echo "version=$version" >> $env:GITHUB_OUTPUT
          echo "Version: $version"

      - name: Package static
        shell: pwsh
        run: |
          $ver = "${{ steps.version.outputs.version }}"
          $arch = "${{ github.event.inputs.arch }}"
          
          cd C:\curl-build
          
          # Create static package
          New-Item -ItemType Directory -Path package-static -Force
          
          # Copy static libs
          if (Test-Path install\static\lib) {
            Copy-Item -Path install\static\lib\*.lib -Destination package-static\ -Force
          }
          
          # Copy headers
          Copy-Item -Path install\*.h -Destination package-static\ -Force -ErrorAction SilentlyContinue
          if (Test-Path install\curl) {
            Copy-Item -Path install\curl\*.h -Destination package-static\curl\ -Force -Recurse
          }
          if (Test-Path install\openssl) {
            Copy-Item -Path install\openssl\*.h -Destination package-static\openssl\ -Force -Recurse
          }
          
          # Create zip
          Compress-Archive -Path package-static\* -DestinationPath libcurl-${ver}-${arch}-static.zip -Force
          
          # List contents
          Get-ChildItem -Path *.zip

      - name: Package shared
        shell: pwsh
        run: |
          $ver = "${{ steps.version.outputs.version }}"
          $arch = "${{ github.event.inputs.arch }}"
          
          cd C:\curl-build
          
          # Create shared package structure
          New-Item -ItemType Directory -Path package-shared\lib -Force
          New-Item -ItemType Directory -Path package-shared\bin -Force
          
          # Copy shared libs (import libs)
          if (Test-Path install\shared\lib) {
            Copy-Item -Path install\shared\lib\*.lib -Destination package-shared\lib\ -Force
          }
          
          # Copy DLLs
          if (Test-Path install\shared\bin) {
            Copy-Item -Path install\shared\bin\*.dll -Destination package-shared\bin\ -Force
          }
          
          # Copy headers
          Copy-Item -Path install\*.h -Destination package-shared\ -Force -ErrorAction SilentlyContinue
          if (Test-Path install\curl) {
            Copy-Item -Path install\curl\*.h -Destination package-shared\curl\ -Force -Recurse
          }
          if (Test-Path install\openssl) {
            Copy-Item -Path install\openssl\*.h -Destination package-shared\openssl\ -Force -Recurse
          }
          
          # Create zip
          Compress-Archive -Path package-shared\* -DestinationPath libcurl-${ver}-${arch}-shared.zip -Force
          
          # List contents
          Get-ChildItem -Path *.zip

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: libcurl-${{ github.event.inputs.arch }}-packages
          path: C:\curl-build\*.zip
          if-no-files-found: error

      - name: List final files
        shell: pwsh
        run: |
          Get-ChildItem -Path C:\curl-build\*.zip
          Get-ChildItem -Path C:\curl-build\install -Recurse

  release:
    needs: build
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/v')
    permissions:
      contents: write
    steps:
      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts
          merge-multiple: true
      
      - name: List downloaded files
        run: ls -la artifacts/
      
      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          files: artifacts/*.zip
          draft: false
          prerelease: false
