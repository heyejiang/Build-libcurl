name: Build libcurl MSVC

on:
  workflow_dispatch:
    inputs:
      arch:
        description: 'Architecture (x64/x86)'
        required: true
        default: 'x64'
        type: choice
        options:
          - x64
          - x86
  push:
    tags:
      - 'v*'

jobs:
  build:
    runs-on: windows-latest
    strategy:
      matrix:
        arch: [x64, x86]
      # 如果手动触发，只构建选择的架构
      max-parallel: 1
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup VS env
        uses: ilammy/msvc-dev-cmd@v1
        with:
          arch: ${{ matrix.arch }}

      - name: Create build dir
        shell: pwsh
        run: |
          New-Item -ItemType Directory -Path C:\curl-build -Force
          New-Item -ItemType Directory -Path C:\curl-build\install -Force

      - name: Build zlib 1.3.1
        shell: cmd
        run: |
          cd C:\curl-build
          git clone --depth 1 --branch v1.3.1 https://github.com/madler/zlib.git
          cd zlib
          nmake /f win32\Makefile.msc clean
          nmake /f win32\Makefile.msc
          copy zlib.lib ..\install\
          copy zlib.h ..\install\
          copy zconf.h ..\install\

      - name: Download OpenSSL 3.0.13
        shell: pwsh
        run: |
          cd C:\curl-build
          if ("${{ matrix.arch }}" -eq "x64") {
            $url = "https://slproweb.com/download/Win64OpenSSL-3_0_13.exe"
          } else {
            $url = "https://slproweb.com/download/Win32OpenSSL-3_0_13.exe"
          }
          Invoke-WebRequest -Uri $url -OutFile openssl.exe
          Start-Process -FilePath .\openssl.exe -ArgumentList "/silent", "/verysilent", "/dir=C:\curl-build\install" -Wait

      - name: Build libssh2 1.11.0
        shell: cmd
        run: |
          cd C:\curl-build
          git clone --depth 1 --branch libssh2-1.11.0 https://github.com/libssh2/libssh2.git
          cd libssh2
          mkdir build
          cd build
          cmake .. -G "Visual Studio 17 2022" -A ${{ matrix.arch == 'x64' && 'x64' || 'Win32' }} ^
            -DCMAKE_INSTALL_PREFIX=C:\curl-build\install ^
            -DCRYPTO_BACKEND=OpenSSL ^
            -DOPENSSL_ROOT_DIR=C:\curl-build\install ^
            -DBUILD_SHARED_LIBS=ON ^
            -DBUILD_EXAMPLES=OFF ^
            -DBUILD_TESTING=OFF
          cmake --build . --config Release
          cmake --install .

      - name: Build libcurl latest (static)
        shell: cmd
        run: |
          cd C:\curl-build
          git clone --depth 1 https://github.com/curl/curl.git
          cd curl
          mkdir build-static
          cd build-static
          cmake .. -G "Visual Studio 17 2022" -A ${{ matrix.arch == 'x64' && 'x64' || 'Win32' }} ^
            -DCMAKE_INSTALL_PREFIX=C:\curl-build\install\static ^
            -DBUILD_SHARED_LIBS=OFF ^
            -DCMAKE_USE_OPENSSL=ON ^
            -DCMAKE_USE_LIBSSH2=ON ^
            -DUSE_ZLIB=ON ^
            -DOPENSSL_ROOT_DIR=C:\curl-build\install ^
            -DHTTP_ONLY=OFF ^
            -DENABLE_IPV6=ON
          cmake --build . --config Release
          cmake --install .

      - name: Build libcurl latest (shared)
        shell: cmd
        run: |
          cd C:\curl-build\curl
          mkdir build-shared
          cd build-shared
          cmake .. -G "Visual Studio 17 2022" -A ${{ matrix.arch == 'x64' && 'x64' || 'Win32' }} ^
            -DCMAKE_INSTALL_PREFIX=C:\curl-build\install\shared ^
            -DBUILD_SHARED_LIBS=ON ^
            -DCMAKE_USE_OPENSSL=ON ^
            -DCMAKE_USE_LIBSSH2=ON ^
            -DUSE_ZLIB=ON ^
            -DOPENSSL_ROOT_DIR=C:\curl-build\install ^
            -DHTTP_ONLY=OFF ^
            -DENABLE_IPV6=ON
          cmake --build . --config Release
          cmake --install .

      - name: Get version
        shell: pwsh
        id: version
        run: |
          cd C:\curl-build\curl
          $tag = git describe --tags --abbrev=0 2>$null
          if ($tag) {
            $version = $tag.TrimStart('curl-')
          } else {
            $version = "latest"
          }
          echo "version=$version" >> $env:GITHUB_OUTPUT

      - name: Package static libs
        shell: pwsh
        run: |
          cd C:\curl-build
          $ver = "${{ steps.version.outputs.version }}"
          $arch = "${{ matrix.arch }}"
          
          New-Item -ItemType Directory -Path package-static -Force
          Copy-Item -Path install\static\lib\* -Destination package-static\ -Force
          Copy-Item -Path install\*.h -Destination package-static\ -Force
          Copy-Item -Path install\curl\*.h -Destination package-static\ -Force -Recurse
          
          Compress-Archive -Path package-static\* -DestinationPath libcurl-${ver}-${arch}-static.zip

      - name: Package shared libs
        shell: pwsh
        run: |
          cd C:\curl-build
          $ver = "${{ steps.version.outputs.version }}"
          $arch = "${{ matrix.arch }}"
          
          New-Item -ItemType Directory -Path package-shared -Force
          New-Item -ItemType Directory -Path package-shared\lib -Force
          New-Item -ItemType Directory -Path package-shared\bin -Force
          
          Copy-Item -Path install\shared\lib\*.lib -Destination package-shared\lib\ -Force
          Copy-Item -Path install\shared\bin\*.dll -Destination package-shared\bin\ -Force
          Copy-Item -Path install\*.h -Destination package-shared\ -Force
          Copy-Item -Path install\curl\*.h -Destination package-shared\ -Force -Recurse
          
          Compress-Archive -Path package-shared\* -DestinationPath libcurl-${ver}-${arch}-shared.zip

      - name: Upload static
        uses: actions/upload-artifact@v4
        with:
          name: libcurl-${{ matrix.arch }}-static
          path: C:\curl-build\libcurl-*-static.zip

      - name: Upload shared
        uses: actions/upload-artifact@v4
        with:
          name: libcurl-${{ matrix.arch }}-shared
          path: C:\curl-build\libcurl-*-shared.zip

  release:
    needs: build
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/v')
    permissions:
      contents: write
    steps:
      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts
          merge-multiple: true
      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          files: artifacts/*.zip
