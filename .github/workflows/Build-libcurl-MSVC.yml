name: Build libcurl MSVC

on:
  workflow_dispatch:
    inputs:
      arch:
        description: 'Architecture (x64/x86)'
        required: true
        default: 'x64'
        type: choice
        options:
          - x64
          - x86
  push:
    tags:
      - 'v*'

jobs:
  build:
    runs-on: windows-latest
    strategy:
      matrix:
        arch: [${{ github.event.inputs.arch || 'x64' }}]
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup VS env
        uses: ilammy/msvc-dev-cmd@v1
        with:
          arch: ${{ matrix.arch == 'x64' && 'x64' || 'x86' }}

      - name: Create build dir
        run: |
          mkdir C:\curl-build -Force
          mkdir C:\curl-build\install -Force

      # zlib 1.3.1
      - name: Build zlib
        run: |
          cd C:\curl-build
          git clone --depth 1 --branch v1.3.1 https://github.com/madler/zlib.git
          cd zlib
          nmake /f win32\Makefile.msc clean
          nmake /f win32\Makefile.msc
          copy zlib.lib ..\install\
          copy zlib.h ..\install\
          copy zconf.h ..\install\

      # OpenSSL 3.0.13 - 使用预编译包加速
      - name: Download OpenSSL
        run: |
          cd C:\curl-build
          if "${{ matrix.arch }}"=="x64" (
            curl -L -o openssl.exe https://slproweb.com/download/Win64OpenSSL-3_0_13.exe
          ) else (
            curl -L -o openssl.exe https://slproweb.com/download/Win32OpenSSL-3_0_13.exe
          )
          .\openssl.exe /silent /verysilent /sp- /suppressmsgboxes /dir=C:\curl-build\install

      # libssh2 1.11.0
      - name: Build libssh2
        run: |
          cd C:\curl-build
          git clone --depth 1 --branch libssh2-1.11.0 https://github.com/libssh2/libssh2.git
          cd libssh2
          mkdir build
          cd build
          cmake .. -G "Visual Studio 17 2022" -A ${{ matrix.arch == 'x64' && 'x64' || 'Win32' }} ^
            -DCMAKE_INSTALL_PREFIX=C:\curl-build\install ^
            -DCRYPTO_BACKEND=OpenSSL ^
            -DOPENSSL_ROOT_DIR=C:\curl-build\install ^
            -DBUILD_SHARED_LIBS=ON ^
            -DBUILD_EXAMPLES=OFF ^
            -DBUILD_TESTING=OFF
          cmake --build . --config Release
          cmake --install .

      # libcurl latest
      - name: Build libcurl
        run: |
          cd C:\curl-build
          git clone --depth 1 https://github.com/curl/curl.git
          cd curl
          mkdir build
          cd build
          
          REM 静态库
          cmake .. -G "Visual Studio 17 2022" -A ${{ matrix.arch == 'x64' && 'x64' || 'Win32' }} ^
            -DCMAKE_INSTALL_PREFIX=C:\curl-build\install\static ^
            -DBUILD_SHARED_LIBS=OFF ^
            -DCMAKE_USE_OPENSSL=ON ^
            -DCMAKE_USE_LIBSSH2=ON ^
            -DUSE_ZLIB=ON ^
            -DOPENSSL_ROOT_DIR=C:\curl-build\install
          cmake --build . --config Release
          cmake --install .
          
          REM 清理
          Remove-Item -Path * -Recurse -Force
          
          REM 动态库
          cmake .. -G "Visual Studio 17 2022" -A ${{ matrix.arch == 'x64' && 'x64' || 'Win32' }} ^
            -DCMAKE_INSTALL_PREFIX=C:\curl-build\install\shared ^
            -DBUILD_SHARED_LIBS=ON ^
            -DCMAKE_USE_OPENSSL=ON ^
            -DCMAKE_USE_LIBSSH2=ON ^
            -DUSE_ZLIB=ON ^
            -DOPENSSL_ROOT_DIR=C:\curl-build\install
          cmake --build . --config Release
          cmake --install .

      # 收集产物
      - name: Collect files
        run: |
          cd C:\curl-build
          $version = (git -C curl describe --tags --abbrev=0).TrimStart('curl-')
          if (-not $version) { $version = "latest" }
          
          mkdir output
          
          # 静态库
          mkdir output\static\lib -Force
          mkdir output\static\include -Force
          copy install\static\lib\*.lib output\static\lib\
          copy install\*.h output\static\include\
          
          # 动态库
          mkdir output\shared\lib -Force
          mkdir output\shared\bin -Force
          mkdir output\shared\include -Force
          copy install\shared\lib\*.lib output\shared\lib\
          copy install\shared\bin\*.dll output\shared\bin\
          copy install\*.h output\shared\include\
          
          # 打包
          Compress-Archive -Path output\static\* -DestinationPath libcurl-${version}-${{ matrix.arch }}-static.zip
          Compress-Archive -Path output\shared\* -DestinationPath libcurl-${version}-${{ matrix.arch }}-shared.zip

      - name: Upload static
        uses: actions/upload-artifact@v4
        with:
          name: libcurl-${{ matrix.arch }}-static
          path: C:\curl-build\libcurl-*-static.zip

      - name: Upload shared
        uses: actions/upload-artifact@v4
        with:
          name: libcurl-${{ matrix.arch }}-shared
          path: C:\curl-build\libcurl-*-shared.zip

  release:
    needs: build
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/v')
    permissions:
      contents: write
    
    steps:
      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts
          merge-multiple: true
      
      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          files: artifacts/*.zip
          draft: false
          prerelease: false
