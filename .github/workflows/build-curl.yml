name: Build libcurl with Dependencies

# è§¦å‘æ¡ä»¶
on:
  # æ‰‹åŠ¨è§¦å‘ï¼šå¯ä»¥åœ¨ GitHub Actions é¡µé¢æ‰‹åŠ¨é€‰æ‹©å¹³å°ç¼–è¯‘
  workflow_dispatch:
    inputs:
      platform:
        description: 'Target platform (linux/windows/macos/all)'
        required: true
        default: 'all'
        type: choice
        options:
          - all
          - linux
          - windows
          - macos
      build_type:
        description: 'Build type (static/shared/both)'
        required: true
        default: 'both'
        type: choice
        options:
          - static
          - shared
          - both

  # åˆ›å»ºæ ‡ç­¾æ—¶è‡ªåŠ¨è§¦å‘ï¼ˆæ­£å¼å‘å¸ƒï¼‰
  push:
    tags:
      - 'v*'           # ä¾‹å¦‚ v8.18.0, v1.2.3

  # æ¨é€åˆ° main åˆ†æ”¯æ—¶åªç¼–è¯‘æµ‹è¯•ï¼ˆä¸å‘å¸ƒï¼‰
  push:
    branches:
      - main
    paths:
      - '**.c'
      - '**.h'
      - 'CMakeLists.txt'
      - '**/CMakeLists.txt'

# ç¡®ä¿å¹¶å‘æ„å»ºä¸å†²çª
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # é¢„å¤„ç†ï¼šè·å–ç‰ˆæœ¬ä¿¡æ¯
  prepare:
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.get_version.outputs.version }}
      date: ${{ steps.get_date.outputs.date }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Get version from tag or use default
        id: get_version
        run: |
          if [[ "${{ github.ref }}" =~ ^refs/tags/v(.*) ]]; then
            VERSION="${BASH_REMATCH[1]}"
          else
            VERSION="8.18.0-dev"
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT
      
      - name: Get current date
        id: get_date
        run: echo "date=$(date +'%Y%m%d')" >> $GITHUB_OUTPUT

  # å®šä¹‰ç¼–è¯‘çŸ©é˜µ
  build-matrix:
    runs-on: ubuntu-latest
    needs: prepare
    outputs:
      matrix: ${{ steps.set-matrix.outputs.matrix }}
    steps:
      - name: Determine build matrix
        id: set-matrix
        run: |
          # æ ¹æ®è¾“å…¥å†³å®šç¼–è¯‘å“ªäº›å¹³å°
          if [[ "${{ github.event.inputs.platform }}" == "all" ]] || [[ "${{ github.ref }}" =~ ^refs/tags/v ]]; then
            # å‘å¸ƒæ ‡ç­¾æˆ–é€‰æ‹© allï¼šç¼–è¯‘æ‰€æœ‰å¹³å°
            MATRIX='{"os":["ubuntu-latest","windows-latest","macos-latest"],"include":[
              {"os":"ubuntu-latest","name":"linux","arch":"x86_64","shell":"bash"},
              {"os":"windows-latest","name":"windows","arch":"x86_64","shell":"pwsh"},
              {"os":"macos-latest","name":"macos","arch":"x86_64","shell":"bash"}
            ]}'
          elif [[ "${{ github.event.inputs.platform }}" == "linux" ]]; then
            MATRIX='{"os":["ubuntu-latest"],"include":[{"os":"ubuntu-latest","name":"linux","arch":"x86_64","shell":"bash"}]}'
          elif [[ "${{ github.event.inputs.platform }}" == "windows" ]]; then
            MATRIX='{"os":["windows-latest"],"include":[{"os":"windows-latest","name":"windows","arch":"x86_64","shell":"pwsh"}]}'
          elif [[ "${{ github.event.inputs.platform }}" == "macos" ]]; then
            MATRIX='{"os":["macos-latest"],"include":[{"os":"macos-latest","name":"macos","arch":"x86_64","shell":"bash"}]}'
          else
            # é»˜è®¤ï¼šåªç¼–è¯‘ Linux
            MATRIX='{"os":["ubuntu-latest"],"include":[{"os":"ubuntu-latest","name":"linux","arch":"x86_64","shell":"bash"}]}'
          fi
          echo "matrix=$MATRIX" >> $GITHUB_OUTPUT

  # æ ¸å¿ƒï¼šç¼–è¯‘ libcurl å’Œæ‰€æœ‰ä¾èµ–
  build:
    needs: [prepare, build-matrix]
    runs-on: ${{ matrix.os }}
    strategy:
      matrix: ${{ fromJson(needs.build-matrix.outputs.matrix) }}
      fail-fast: false  # ä¸€ä¸ªå¹³å°å¤±è´¥ä¸å½±å“å…¶ä»–å¹³å°

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up environment (Linux)
        if: runner.os == 'Linux'
        run: |
          sudo apt update
          sudo apt install -y \
            build-essential cmake ninja-build \
            autoconf libtool pkg-config \
            perl python3 python3-pip \
            mingw-w64  # å¦‚æœéœ€è¦äº¤å‰ç¼–è¯‘
          
      - name: Set up environment (macOS)
        if: runner.os == 'macOS'
        run: |
          brew update
          brew install cmake ninja autoconf automake libtool pkg-config
          
      - name: Set up environment (Windows)
        if: runner.os == 'Windows'
        run: |
          choco install -y cmake --installargs 'ADD_CMAKE_TO_PATH=System'
          choco install -y ninja
          # å®‰è£… Visual Studio æ„å»ºå·¥å…·ï¼ˆGitHub Windows é•œåƒå·²é¢„è£…ï¼‰
          echo "VS Devç¯å¢ƒå·²å°±ç»ª"

      - name: Create build directory
        run: mkdir -p ${{ runner.temp }}/curl-build

      # === ç¼–è¯‘ zlib ===
      - name: Download and build zlib
        shell: ${{ matrix.shell }}
        run: |
          cd ${{ runner.temp }}/curl-build
          git clone --depth 1 --branch v1.3.1 https://github.com/madler/zlib.git
          cd zlib
          mkdir build && cd build
          
          if [[ "${{ runner.os }}" == "Windows" ]]; then
            cmake .. -G "Ninja" \
              -DCMAKE_BUILD_TYPE=Release \
              -DCMAKE_INSTALL_PREFIX="${{ runner.temp }}/curl-build/install"
          else
            cmake .. -G "Ninja" \
              -DCMAKE_BUILD_TYPE=Release \
              -DCMAKE_INSTALL_PREFIX="${{ runner.temp }}/curl-build/install"
          fi
          
          cmake --build . --config Release
          cmake --install .

      # === ç¼–è¯‘ OpenSSL ===
      - name: Download and build OpenSSL
        shell: ${{ matrix.shell }}
        run: |
          cd ${{ runner.temp }}/curl-build
          git clone --depth 1 --branch openssl-3.0.13 https://github.com/openssl/openssl.git
          cd openssl
          
          if [[ "${{ runner.os }}" == "Windows" ]]; then
            # Windows ä¸‹ä½¿ç”¨ Perl ç¼–è¯‘
            perl Configure VC-WIN64A --prefix="${{ runner.temp }}/curl-build/install" --openssldir="${{ runner.temp }}/curl-build/install/ssl"
            nmake
            nmake install
          elif [[ "${{ runner.os }}" == "macOS" ]]; then
            ./Configure darwin64-x86_64-cc --prefix="${{ runner.temp }}/curl-build/install" --openssldir="${{ runner.temp }}/curl-build/install/ssl"
            make -j$(nproc)
            make install
          else
            # Linux
            ./config --prefix="${{ runner.temp }}/curl-build/install" --openssldir="${{ runner.temp }}/curl-build/install/ssl" shared
            make -j$(nproc)
            make install
          fi

      # === ç¼–è¯‘ libssh2 ===
      - name: Download and build libssh2
        shell: ${{ matrix.shell }}
        run: |
          cd ${{ runner.temp }}/curl-build
          git clone --depth 1 --branch libssh2-1.11.0 https://github.com/libssh2/libssh2.git
          cd libssh2
          mkdir build && cd build
          
          cmake .. -G "Ninja" \
            -DCMAKE_BUILD_TYPE=Release \
            -DCMAKE_INSTALL_PREFIX="${{ runner.temp }}/curl-build/install" \
            -DCRYPTO_BACKEND=OpenSSL \
            -DOPENSSL_ROOT_DIR="${{ runner.temp }}/curl-build/install" \
            -DOPENSSL_INCLUDE_DIR="${{ runner.temp }}/curl-build/install/include" \
            -DOPENSSL_LIBRARIES="${{ runner.temp }}/curl-build/install/lib" \
            -DBUILD_SHARED_LIBS=OFF \
            -DBUILD_EXAMPLES=OFF \
            -DBUILD_TESTING=OFF
          
          cmake --build . --config Release
          cmake --install .

      # === ç¼–è¯‘ libcurl ===
      - name: Configure and build libcurl
        shell: ${{ matrix.shell }}
        run: |
          cd ${{ runner.temp }}/curl-build
          mkdir curl && cd curl
          
          # ç¡®å®šæ„å»ºç±»å‹
          BUILD_SHARED=${{ github.event.inputs.build_type == 'shared' || github.event.inputs.build_type == 'both' }}
          BUILD_STATIC=${{ github.event.inputs.build_type == 'static' || github.event.inputs.build_type == 'both' }}
          
          # ä½¿ç”¨ CMake æ„å»ºï¼ˆè·¨å¹³å°ä¸€è‡´æ€§æ›´å¥½ï¼‰
          cmake ${{ github.workspace }} -G "Ninja" \
            -DCMAKE_BUILD_TYPE=Release \
            -DCMAKE_INSTALL_PREFIX="${{ runner.temp }}/curl-build/install" \
            -DCMAKE_PREFIX_PATH="${{ runner.temp }}/curl-build/install" \
            -DBUILD_SHARED_LIBS=$BUILD_SHARED \
            -DBUILD_STATIC_LIBS=$BUILD_STATIC \
            -DCMAKE_USE_OPENSSL=ON \
            -DCMAKE_USE_LIBSSH2=ON \
            -DUSE_ZLIB=ON \
            -DCURL_USE_LIBSSH2=ON \
            -DCURL_ZLIB=ON \
            -DHTTP_ONLY=OFF \
            -DENABLE_IPV6=ON \
            -DBUILD_CURL_EXE=ON \
            -DBUILD_TESTING=OFF
          
          cmake --build . --config Release
          cmake --install .

      # === æ‰“åŒ…ç¼–è¯‘äº§ç‰© ===
      - name: Package artifacts (Linux/macOS)
        if: runner.os != 'Windows'
        run: |
          cd ${{ runner.temp }}/curl-build/install
          tar -czf ${{ runner.temp }}/libcurl-${{ needs.prepare.outputs.version }}-${{ matrix.name }}-${{ matrix.arch }}.tar.gz *
          
      - name: Package artifacts (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          Compress-Archive -Path "${{ runner.temp }}/curl-build/install/*" `
            -DestinationPath "${{ runner.temp }}/libcurl-${{ needs.prepare.outputs.version }}-${{ matrix.name }}-${{ matrix.arch }}.zip"

      # === ä¸Šä¼ äº§ç‰©åˆ° Actions Artifactsï¼ˆä¸´æ—¶å­˜å‚¨ï¼‰ ===
      - name: Upload artifacts to Actions
        uses: actions/upload-artifact@v4
        with:
          name: libcurl-${{ needs.prepare.outputs.version }}-${{ matrix.name }}-${{ matrix.arch }}
          path: ${{ runner.temp }}/libcurl-${{ needs.prepare.outputs.version }}-${{ matrix.name }}-${{ matrix.arch }}.*
          retention-days: 30
          if-no-files-found: error

  # === åˆ›å»º/æ›´æ–° Release ===
  release:
    needs: [prepare, build]
    runs-on: ubuntu-latest
    # åªåœ¨æ ‡ç­¾è§¦å‘æˆ–æ‰‹åŠ¨è§¦å‘ä¸”é€‰æ‹©å‘å¸ƒæ—¶æ‰§è¡Œ
    if: startsWith(github.ref, 'refs/tags/v') || github.event.inputs.release == 'true'
    permissions:
      contents: write  # éœ€è¦å†™å…¥æƒé™åˆ›å»º Release
      packages: write
      
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts
          merge-multiple: true
      
      - name: Display structure of downloaded files
        run: ls -la artifacts/
      
      - name: Create Release
        id: create_release
        uses: softprops/action-gh-release@v2
        with:
          name: libcurl ${{ needs.prepare.outputs.version }}
          tag_name: ${{ github.ref_name }}
          body: |
            # libcurl ${{ needs.prepare.outputs.version }} è‡ªåŠ¨æ„å»ºåŒ…
            
            ## ğŸ“¦ åŒ…å«çš„ä¾èµ–
            - OpenSSL 3.0.13
            - zlib 1.3.1
            - libssh2 1.11.0
            
            ## ğŸ¯ æ”¯æŒåè®®
            - HTTP/HTTPS (with OpenSSL)
            - FTP/FTPS
            - SCP/SFTP (with libssh2)
            - æ›´å¤š...
            
            ## ğŸ”§ ç¼–è¯‘é…ç½®
            - çº¿ç¨‹å®‰å…¨è§£æå™¨ (threaded-resolver)
            - IPv6 æ”¯æŒ
            - å¼‚æ­¥DNS
            - ç¬¦å·ç‰ˆæœ¬æ§åˆ¶
            
            ## ğŸ“ æ–‡ä»¶è¯´æ˜
            - `*-linux-*.tar.gz`: Linux å¹³å°é™æ€åº“/åŠ¨æ€åº“
            - `*-windows-*.zip`: Windows å¹³å°åº“æ–‡ä»¶
            - `*-macos-*.tar.gz`: macOS å¹³å°åº“æ–‡ä»¶
            
            ## ğŸš€ ä½¿ç”¨æ–¹å¼
            è¯·å‚è€ƒ [libcurl å®˜æ–¹æ–‡æ¡£](https://curl.se/libcurl/)
            
            ## âœ¨ æ„å»ºä¿¡æ¯
            - æ„å»ºæ—¶é—´: ${{ needs.prepare.outputs.date }}
            - è§¦å‘äº‹ä»¶: ${{ github.event_name }}
            - æäº¤å“ˆå¸Œ: ${{ github.sha }}
          files: |
            artifacts/*
          draft: false
          prerelease: ${{ contains(github.ref_name, 'beta') || contains(github.ref_name, 'alpha') }}
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # === æ¨é€å®Œæˆé€šçŸ¥ ===
  notify:
    needs: [release]
    runs-on: ubuntu-latest
    if: always() && needs.release.result == 'success'
    steps:
      - name: Send notification (å¯é€‰)
        run: |
          echo "âœ… æ„å»ºå®Œæˆå¹¶å·²å‘å¸ƒåˆ° Release"
          echo "ç‰ˆæœ¬: ${{ needs.prepare.outputs.version }}"
          echo "æŸ¥çœ‹åœ°å€: https://github.com/${{ github.repository }}/releases/tag/${{ github.ref_name }}"
